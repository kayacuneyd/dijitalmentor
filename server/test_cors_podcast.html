<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast CORS Tester</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        pre {
            background: #f8f9fa;
            padding: 10px;
            border: 1px solid #ddd;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>Podcast API CORS Tester</h1>

    <div>
        <h3>1. Test List Endpoint (GET)</h3>
        <button onclick="testList()">Test List</button>
    </div>

    <div>
        <h3>2. Test Create Endpoint (POST)</h3>
        <button onclick="testCreate()">Test Create</button>
    </div>

    <div id="output"></div>

    <script>
        const API_BASE = 'https://api.dijitalmentor.de/server/api/admin/podcast';
        const output = document.getElementById('output');

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${msg}`;
            output.prepend(div);
        }

        function logData(data) {
            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(data, null, 2);
            output.prepend(pre);
        }

        async function testList() {
            log('Testing GET /list.php...');
            try {
                // We assume the user is logged in to the main site, so we include credentials
                const res = await fetch(`${API_BASE}/list.php`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // Important: This tests if cookies/auth are sent and accepted
                    credentials: 'include'
                });

                log(`Response Status: ${res.status} ${res.statusText}`, res.ok ? 'success' : 'error');

                const text = await res.text();
                try {
                    const json = JSON.parse(text);
                    logData(json);
                } catch (e) {
                    log('Response is not JSON:', 'error');
                    logData(text);
                }

            } catch (err) {
                log(`Fetch Error: ${err.message}`, 'error');
                if (err.message.includes('Failed to fetch')) {
                    log('Possible CORS error or Network error. Check console (F12) for "Access-Control-Allow-Origin" messages.', 'error');
                }
            }
        }

        async function testCreate() {
            log('Testing POST /create.php...');
            try {
                const res = await fetch(`${API_BASE}/create.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        title: 'CORS Test Episode',
                        topic_prompt: 'Testing CORS headers',
                        trigger_generation: false // Don't actually trigger GitHub for this test
                    })
                });

                log(`Response Status: ${res.status} ${res.statusText}`, res.ok ? 'success' : 'error');

                const text = await res.text();
                try {
                    const json = JSON.parse(text);
                    logData(json);
                } catch (e) {
                    log('Response is not JSON:', 'error');
                    logData(text);
                }

            } catch (err) {
                log(`Fetch Error: ${err.message}`, 'error');
                if (err.message.includes('Failed to fetch')) {
                    log('Possible CORS error or Network error. Check console (F12) for "Access-Control-Allow-Origin" messages.', 'error');
                }
            }
        }
    </script>
</body>

</html>